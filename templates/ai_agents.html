<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Management - RiskTravel Intelligence</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-bg: #1a252f;
            --card-bg: #2c3e50;
            --text-light: #ecf0f1;
            --border-color: #34495e;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg) 0%, var(--primary-color) 100%);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .navbar {
            background: rgba(44, 62, 80, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }
        
        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }
        
        .card-header {
            background: rgba(52, 73, 94, 0.8);
            border-bottom: 1px solid var(--border-color);
            border-radius: 12px 12px 0 0 !important;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--secondary-color), #2980b9);
            border: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #2980b9, var(--secondary-color));
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, var(--success-color), #229954);
            border: none;
            border-radius: 8px;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, var(--warning-color), #e67e22);
            border: none;
            border-radius: 8px;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, var(--danger-color), #c0392b);
            border: none;
            border-radius: 8px;
        }
        
        .agent-card {
            position: relative;
            overflow: hidden;
        }
        
        .agent-status {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active {
            background: var(--success-color);
            color: white;
        }
        
        .status-paused {
            background: var(--warning-color);
            color: white;
        }
        
        .status-inactive {
            background: var(--danger-color);
            color: white;
        }
        
        .status-development {
            background: #9b59b6;
            color: white;
        }
        
        .status-beta {
            background: #f39c12;
            color: white;
        }
        
        .performance-metric {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .performance-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .performance-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .tier-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .tier-revenue_generation {
            background: #27ae60;
            color: white;
        }
        
        .tier-authority_building {
            background: #3498db;
            color: white;
        }
        
        .tier-platform_development {
            background: #9b59b6;
            color: white;
        }
        
        .tier-efficiency_automation {
            background: #f39c12;
            color: white;
        }
        
        .tier-intelligence_analysis {
            background: #e74c3c;
            color: white;
        }
        
        .modal-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }
        
        .modal-header {
            border-bottom: 1px solid var(--border-color);
        }
        
        .form-control {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 8px;
        }
        
        .form-control:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--secondary-color);
            color: var(--text-light);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .form-control::placeholder {
            color: rgba(236, 240, 241, 0.6);
        }
        
        .form-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 8px;
        }
        
        .form-select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--secondary-color);
            color: var(--text-light);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .tools-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .tool-tag {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid var(--secondary-color);
            color: var(--secondary-color);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .tool-tag .remove-tool {
            cursor: pointer;
            opacity: 0.7;
        }
        
        .tool-tag .remove-tool:hover {
            opacity: 1;
            color: var(--danger-color);
        }
        
        .progress {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
        }
        
        .progress-bar {
            border-radius: 10px;
        }
        
        .alert {
            border: none;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .alert-success {
            background: rgba(39, 174, 96, 0.2);
            color: #2ecc71;
            border-left: 4px solid #2ecc71;
        }
        
        .alert-danger {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border-left: 4px solid #e74c3c;
        }
        
        .alert-info {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border-left: 4px solid #3498db;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(45deg, var(--secondary-color), #2980b9);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .filters-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner-border {
            color: var(--secondary-color);
        }
        
        @media (max-width: 768px) {
            .agent-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .nav-link {
            color: var(--text-light) !important;
            transition: color 0.3s ease;
        }
        
        .nav-link:hover {
            color: var(--secondary-color) !important;
        }
        
        .navbar-brand {
            color: var(--text-light) !important;
            font-weight: bold;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot me-2"></i>AI Agent Management
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/ai-agents">
                            <i class="fas fa-robot me-1"></i>AI Agents
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container" style="margin-top: 100px;">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-0">
                    <i class="fas fa-robot me-2"></i>AI Agent Management
                </h1>
                <p class="text-muted mb-0">Monitor, configure, and manage your AI agent ecosystem</p>
            </div>
            <div>
                <button class="btn btn-primary me-2" onclick="createAgent()">
                    <i class="fas fa-plus me-2"></i>Create Agent
                </button>
                <button class="btn btn-outline-secondary" onclick="bulkOperations()">
                    <i class="fas fa-tasks me-2"></i>Bulk Operations
                </button>
            </div>
        </div>

        <!-- Dashboard Statistics -->
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-value" id="totalAgents">-</div>
                <div class="stat-label">Total Agents</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="activeAgents">-</div>
                <div class="stat-label">Active Agents</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pausedAgents">-</div>
                <div class="stat-label">Paused Agents</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">-</div>
                <div class="stat-label">Pipeline Value</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgPerformance">-</div>
                <div class="stat-label">Avg Performance</div>
            </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label for="tierFilter" class="form-label">Filter by Tier</label>
                    <select class="form-select" id="tierFilter" onchange="filterAgents()">
                        <option value="">All Tiers</option>
                        <option value="revenue_generation">Revenue Generation</option>
                        <option value="authority_building">Authority Building</option>
                        <option value="platform_development">Platform Development</option>
                        <option value="efficiency_automation">Efficiency Automation</option>
                        <option value="intelligence_analysis">Intelligence Analysis</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Filter by Status</label>
                    <select class="form-select" id="statusFilter" onchange="filterAgents()">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="paused">Paused</option>
                        <option value="inactive">Inactive</option>
                        <option value="development">Development</option>
                        <option value="beta">Beta</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="searchInput" class="form-label">Search Agents</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search by name or function..." onkeyup="filterAgents()">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Loading Spinner -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading agents...</div>
        </div>

        <!-- Agents Grid -->
        <div class="agent-grid" id="agentsGrid">
            <!-- Agents will be loaded here dynamically -->
        </div>
    </div>

    <!-- Create/Edit Agent Modal -->
    <div class="modal fade" id="agentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="agentModalTitle">Create New Agent</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="agentForm">
                        <input type="hidden" id="agentId">
                        
                        <!-- Basic Information -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="agentName" class="form-label">Agent Name *</label>
                                <input type="text" class="form-control" id="agentName" required>
                            </div>
                            <div class="col-md-6">
                                <label for="agentTier" class="form-label">Tier *</label>
                                <select class="form-select" id="agentTier" required>
                                    <option value="">Select Tier</option>
                                    <option value="revenue_generation">Revenue Generation</option>
                                    <option value="authority_building">Authority Building</option>
                                    <option value="platform_development">Platform Development</option>
                                    <option value="efficiency_automation">Efficiency Automation</option>
                                    <option value="intelligence_analysis">Intelligence Analysis</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="agentStatus" class="form-label">Status</label>
                                <select class="form-select" id="agentStatus">
                                    <option value="active">Active</option>
                                    <option value="paused">Paused</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="development">Development</option>
                                    <option value="beta">Beta</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="nextScheduled" class="form-label">Next Scheduled</label>
                                <input type="datetime-local" class="form-control" id="nextScheduled">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="agentFunction" class="form-label">Function Description *</label>
                            <textarea class="form-control" id="agentFunction" rows="3" required placeholder="Describe what this agent does..."></textarea>
                        </div>

                        <!-- Tools -->
                        <div class="mb-3">
                            <label for="agentTools" class="form-label">Tools</label>
                            <div class="tools-container" id="toolsContainer"></div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="newToolInput" placeholder="Add tool (e.g., Apollo, LinkedIn Sales Navigator)">
                                <button type="button" class="btn btn-outline-secondary" onclick="addTool()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Performance Metrics -->
                        <div class="mb-3">
                            <label class="form-label">Performance Metrics</label>
                            <div class="row" id="performanceMetrics">
                                <!-- Performance metrics will be dynamically added here -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addPerformanceMetric()">
                                <i class="fas fa-plus me-1"></i>Add Metric
                            </button>
                        </div>

                        <!-- Additional Fields (dynamic based on tier) -->
                        <div id="additionalFields">
                            <!-- Fields will be dynamically populated based on tier selection -->
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveAgent()">
                        <i class="fas fa-save me-1"></i>Save Agent
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Assignment Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <input type="hidden" id="taskAgentId">
                        
                        <div class="mb-3">
                            <label for="taskTitle" class="form-label">Task Title *</label>
                            <input type="text" class="form-control" id="taskTitle" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="taskDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="taskPriority" class="form-label">Priority</label>
                                <select class="form-select" id="taskPriority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="taskDeadline" class="form-label">Deadline</label>
                                <input type="datetime-local" class="form-control" id="taskDeadline">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="taskNotes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="taskNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="assignTask()">
                        <i class="fas fa-check me-1"></i>Assign Task
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Details Modal -->
    <div class="modal fade" id="performanceModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="performanceModalTitle">Agent Performance Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                    <div id="performanceDetails" class="mt-4">
                        <!-- Performance details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Operations Modal -->
    <div class="modal fade" id="bulkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Bulk Operations</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Operation</label>
                        <select class="form-select" id="bulkOperation">
                            <option value="">Choose operation...</option>
                            <option value="activate">Activate Selected Agents</option>
                            <option value="pause">Pause Selected Agents</option>
                            <option value="update_status">Update Status</option>
                            <option value="assign_task">Assign Task to Multiple</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="bulkStatusUpdate" style="display: none;">
                        <label for="bulkStatus" class="form-label">New Status</label>
                        <select class="form-select" id="bulkStatus">
                            <option value="active">Active</option>
                            <option value="paused">Paused</option>
                            <option value="inactive">Inactive</option>
                            <option value="development">Development</option>
                            <option value="beta">Beta</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Selected Agents</label>
                        <div id="selectedAgents" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <p class="text-muted mb-0">No agents selected. Click on agent cards to select them.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="executeBulkOperation()">
                        <i class="fas fa-play me-1"></i>Execute
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        // Global variables
        let agents = [];
        let filteredAgents = [];
        let selectedAgents = new Set();
        let performanceChart = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadAgents();
            setupEventListeners();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshData, 30000);
        });

        // Setup event listeners
        function setupEventListeners() {
            // Agent tier change handler
            document.getElementById('agentTier').addEventListener('change', function() {
                populateAdditionalFields(this.value);
            });
            
            // Bulk operation change handler
            document.getElementById('bulkOperation').addEventListener('change', function() {
                const statusUpdate = document.getElementById('bulkStatusUpdate');
                statusUpdate.style.display = this.value === 'update_status' ? 'block' : 'none';
            });
            
            // Tool input enter key handler
            document.getElementById('newToolInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTool();
                }
            });
        }

        // Load agents from API
        async function loadAgents() {
            try {
                showLoading(true);
                const response = await fetch('/api/ai-agents');
                if (!response.ok) throw new Error('Failed to load agents');
                
                agents = await response.json();
                filteredAgents = [...agents];
                renderAgents();
                updateDashboardStats();
                showAlert('Agents loaded successfully', 'success');
            } catch (error) {
                console.error('Error loading agents:', error);
                showAlert('Failed to load agents: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        // Render agents in the grid
        function renderAgents() {
            const grid = document.getElementById('agentsGrid');
            
            if (filteredAgents.length === 0) {
                grid.innerHTML = `
                    <div class="col-12">
                        <div class="card text-center">
                            <div class="card-body">
                                <i class="fas fa-robot fa-3x mb-3 text-muted"></i>
                                <h5>No agents found</h5>
                                <p class="text-muted">Create your first AI agent to get started</p>
                                <button class="btn btn-primary" onclick="createAgent()">
                                    <i class="fas fa-plus me-2"></i>Create Agent
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredAgents.map(agent => createAgentCard(agent)).join('');
        }

        // Create agent card HTML
        function createAgentCard(agent) {
            const performance = agent.performance || {};
            const tools = agent.tools || [];
            const isSelected = selectedAgents.has(agent.id);
            
            return `
                <div class="agent-card card ${isSelected ? 'border-primary' : ''}" data-agent-id="${agent.id}" onclick="toggleAgentSelection(${agent.id})">
                    <div class="agent-status status-${agent.status}">${agent.status}</div>
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title mb-1">${agent.name}</h6>
                                <span class="tier-badge tier-${agent.tier}">${agent.tier.replace('_', ' ')}</span>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editAgent(${agent.id}); event.stopPropagation();"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="viewPerformance(${agent.id}); event.stopPropagation();"><i class="fas fa-chart-line me-2"></i>Performance</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="assignAgentTask(${agent.id}); event.stopPropagation();"><i class="fas fa-tasks me-2"></i>Assign Task</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="toggleAgentStatus(${agent.id}, '${agent.status === 'active' ? 'paused' : 'active'}'); event.stopPropagation();">
                                        <i class="fas fa-${agent.status === 'active' ? 'pause' : 'play'} me-2"></i>${agent.status === 'active' ? 'Pause' : 'Activate'}
                                    </a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteAgent(${agent.id}); event.stopPropagation();"><i class="fas fa-trash me-2"></i>Delete</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="card-text small">${agent.function.substring(0, 120)}${agent.function.length > 120 ? '...' : ''}</p>
                        
                        ${tools.length > 0 ? `
                            <div class="tools-container mb-3">
                                ${tools.slice(0, 3).map(tool => `<span class="tool-tag">${tool}</span>`).join('')}
                                ${tools.length > 3 ? `<span class="tool-tag">+${tools.length - 3} more</span>` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="row">
                            ${Object.keys(performance).slice(0, 2).map(key => `
                                <div class="col-6">
                                    <div class="performance-metric">
                                        <div class="performance-value">${performance[key]}</div>
                                        <div class="performance-label">${key.replace('_', ' ')}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                ${agent.last_activity ? new Date(agent.last_activity).toLocaleDateString() : 'Never'}
                            </small>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-success" onclick="toggleAgentStatus(${agent.id}, 'active'); event.stopPropagation();" ${agent.status === 'active' ? 'disabled' : ''}>
                                    <i class="fas fa-play"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning" onclick="toggleAgentStatus(${agent.id}, 'paused'); event.stopPropagation();" ${agent.status === 'paused' ? 'disabled' : ''}>
                                    <i class="fas fa-pause"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="toggleAgentStatus(${agent.id}, 'inactive'); event.stopPropagation();" ${agent.status === 'inactive' ? 'disabled' : ''}>
                                    <i class="fas fa-stop"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Toggle agent selection for bulk operations
        function toggleAgentSelection(agentId) {
            if (selectedAgents.has(agentId)) {
                selectedAgents.delete(agentId);
            } else {
                selectedAgents.add(agentId);
            }
            
            // Update visual selection
            const card = document.querySelector(`[data-agent-id="${agentId}"]`);
            if (selectedAgents.has(agentId)) {
                card.classList.add('border-primary');
            } else {
                card.classList.remove('border-primary');
            }
            
            updateSelectedAgentsDisplay();
        }

        // Update selected agents display in bulk modal
        function updateSelectedAgentsDisplay() {
            const container = document.getElementById('selectedAgents');
            if (selectedAgents.size === 0) {
                container.innerHTML = '<p class="text-muted mb-0">No agents selected. Click on agent cards to select them.</p>';
            } else {
                const selectedAgentsList = Array.from(selectedAgents).map(id => {
                    const agent = agents.find(a => a.id === id);
                    return agent ? `<span class="badge bg-primary me-1">${agent.name}</span>` : '';
                }).join('');
                container.innerHTML = selectedAgentsList;
            }
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            document.getElementById('totalAgents').textContent = agents.length;
            document.getElementById('activeAgents').textContent = agents.filter(a => a.status === 'active').length;
            document.getElementById('pausedAgents').textContent = agents.filter(a => a.status === 'paused').length;
            
            // Calculate pipeline value from performance data
            let totalPipeline = 0;
            let performanceSum = 0;
            let performanceCount = 0;
            
            agents.forEach(agent => {
                if (agent.performance) {
                    if (agent.performance.pipeline_value) {
                        totalPipeline += agent.performance.pipeline_value;
                    }
                    if (agent.performance.success_rate) {
                        performanceSum += agent.performance.success_rate;
                        performanceCount++;
                    }
                }
            });
            
            document.getElementById('totalRevenue').textContent = totalPipeline > 0 ? 
                '$' + (totalPipeline / 1000000).toFixed(1) + 'M' : '$0';
            document.getElementById('avgPerformance').textContent = performanceCount > 0 ?
                (performanceSum / performanceCount).toFixed(1) + '%' : '0%';
        }

        // Filter agents based on current filter settings
        function filterAgents() {
            const tierFilter = document.getElementById('tierFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            
            filteredAgents = agents.filter(agent => {
                const matchesTier = !tierFilter || agent.tier === tierFilter;
                const matchesStatus = !statusFilter || agent.status === statusFilter;
                const matchesSearch = !searchInput || 
                    agent.name.toLowerCase().includes(searchInput) ||
                    agent.function.toLowerCase().includes(searchInput);
                    
                return matchesTier && matchesStatus && matchesSearch;
            });
            
            renderAgents();
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('tierFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchInput').value = '';
            filterAgents();
        }

        // Create new agent
        function createAgent() {
            document.getElementById('agentModalTitle').textContent = 'Create New Agent';
            document.getElementById('agentForm').reset();
            document.getElementById('agentId').value = '';
            document.getElementById('toolsContainer').innerHTML = '';
            document.getElementById('performanceMetrics').innerHTML = '';
            document.getElementById('additionalFields').innerHTML = '';
            new bootstrap.Modal(document.getElementById('agentModal')).show();
        }

        // Edit existing agent
        function editAgent(agentId) {
            const agent = agents.find(a => a.id === agentId);
            if (!agent) return;
            
            document.getElementById('agentModalTitle').textContent = 'Edit Agent';
            document.getElementById('agentId').value = agent.id;
            document.getElementById('agentName').value = agent.name;
            document.getElementById('agentTier').value = agent.tier;
            document.getElementById('agentStatus').value = agent.status;
            document.getElementById('agentFunction').value = agent.function;
            
            if (agent.next_scheduled) {
                const date = new Date(agent.next_scheduled);
                document.getElementById('nextScheduled').value = date.toISOString().slice(0, 16);
            }
            
            // Populate tools
            const toolsContainer = document.getElementById('toolsContainer');
            toolsContainer.innerHTML = '';
            (agent.tools || []).forEach(tool => {
                addToolToContainer(tool);
            });
            
            // Populate performance metrics
            const metricsContainer = document.getElementById('performanceMetrics');
            metricsContainer.innerHTML = '';
            const performance = agent.performance || {};
            Object.keys(performance).forEach(key => {
                addPerformanceMetricToContainer(key, performance[key]);
            });
            
            populateAdditionalFields(agent.tier, agent);
            new bootstrap.Modal(document.getElementById('agentModal')).show();
        }

        // Populate additional fields based on tier
        function populateAdditionalFields(tier, agent = null) {
            const container = document.getElementById('additionalFields');
            container.innerHTML = '';
            
            const tierFields = {
                'revenue_generation': [
                    { name: 'revenue_target', label: 'Revenue Target', type: 'text' },
                    { name: 'weekly_goal', label: 'Weekly Goal', type: 'text' },
                    { name: 'pricing', label: 'Pricing Model', type: 'text' }
                ],
                'authority_building': [
                    { name: 'output', label: 'Content Output', type: 'text' },
                    { name: 'goal', label: 'Growth Goal', type: 'text' },
                    { name: 'strategy', label: 'Strategy', type: 'text' }
                ],
                'platform_development': [
                    { name: 'capability', label: 'Core Capability', type: 'text' },
                    { name: 'licensing', label: 'Licensing Model', type: 'text' },
                    { name: 'revenue', label: 'Revenue Model', type: 'text' }
                ]
            };
            
            const fields = tierFields[tier] || [];
            if (fields.length === 0) return;
            
            const html = `
                <div class="mb-3">
                    <h6>Tier-Specific Fields</h6>
                    <div class="row">
                        ${fields.map(field => `
                            <div class="col-md-6 mb-3">
                                <label for="${field.name}" class="form-label">${field.label}</label>
                                <input type="${field.type}" class="form-control" id="${field.name}" 
                                       value="${agent && agent[field.name] ? agent[field.name] : ''}">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Add tool to the tools container
        function addTool() {
            const input = document.getElementById('newToolInput');
            const tool = input.value.trim();
            if (tool) {
                addToolToContainer(tool);
                input.value = '';
            }
        }

        function addToolToContainer(tool) {
            const container = document.getElementById('toolsContainer');
            const toolElement = document.createElement('div');
            toolElement.className = 'tool-tag';
            toolElement.innerHTML = `
                ${tool}
                <span class="remove-tool" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </span>
            `;
            container.appendChild(toolElement);
        }

        // Add performance metric
        function addPerformanceMetric() {
            const name = prompt('Enter metric name:');
            const value = prompt('Enter metric value:');
            if (name && value) {
                addPerformanceMetricToContainer(name, value);
            }
        }

        function addPerformanceMetricToContainer(name, value) {
            const container = document.getElementById('performanceMetrics');
            const metricElement = document.createElement('div');
            metricElement.className = 'col-md-6 mb-2';
            metricElement.innerHTML = `
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" value="${name}" placeholder="Metric name">
                    <input type="text" class="form-control" value="${value}" placeholder="Value">
                    <button class="btn btn-outline-danger" type="button" onclick="this.closest('.col-md-6').remove()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(metricElement);
        }

        // Save agent (create or update)
        async function saveAgent() {
            try {
                const form = document.getElementById('agentForm');
                const formData = new FormData(form);
                
                // Collect tools
                const tools = Array.from(document.querySelectorAll('#toolsContainer .tool-tag'))
                    .map(el => el.textContent.trim());
                
                // Collect performance metrics
                const performance = {};
                document.querySelectorAll('#performanceMetrics .input-group').forEach(group => {
                    const inputs = group.querySelectorAll('input');
                    const name = inputs[0].value.trim();
                    const value = inputs[1].value.trim();
                    if (name && value) {
                        performance[name] = isNaN(value) ? value : parseFloat(value);
                    }
                });
                
                const agentData = {
                    name: document.getElementById('agentName').value,
                    tier: document.getElementById('agentTier').value,
                    function: document.getElementById('agentFunction').value,
                    status: document.getElementById('agentStatus').value,
                    tools: tools,
                    performance: performance,
                    next_scheduled: document.getElementById('nextScheduled').value || null
                };
                
                // Add tier-specific fields
                const additionalFields = document.querySelectorAll('#additionalFields input');
                additionalFields.forEach(input => {
                    if (input.value.trim()) {
                        agentData[input.id] = input.value.trim();
                    }
                });
                
                const agentId = document.getElementById('agentId').value;
                const url = agentId ? `/api/ai-agents/${agentId}` : '/api/ai-agents';
                const method = agentId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(agentData)
                });
                
                if (!response.ok) throw new Error('Failed to save agent');
                
                bootstrap.Modal.getInstance(document.getElementById('agentModal')).hide();
                await loadAgents();
                showAlert(`Agent ${agentId ? 'updated' : 'created'} successfully`, 'success');
                
            } catch (error) {
                console.error('Error saving agent:', error);
                showAlert('Failed to save agent: ' + error.message, 'danger');
            }
        }

        // Delete agent
        async function deleteAgent(agentId) {
            if (!confirm('Are you sure you want to delete this agent? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/ai-agents/${agentId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) throw new Error('Failed to delete agent');
                
                await loadAgents();
                showAlert('Agent deleted successfully', 'success');
                
            } catch (error) {
                console.error('Error deleting agent:', error);
                showAlert('Failed to delete agent: ' + error.message, 'danger');
            }
        }

        // Toggle agent status
        async function toggleAgentStatus(agentId, newStatus) {
            try {
                const response = await fetch(`/api/ai-agents/${agentId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (!response.ok) throw new Error('Failed to update agent status');
                
                await loadAgents();
                showAlert(`Agent status updated to ${newStatus}`, 'success');
                
            } catch (error) {
                console.error('Error updating agent status:', error);
                showAlert('Failed to update agent status: ' + error.message, 'danger');
            }
        }

        // Assign task to agent
        function assignAgentTask(agentId) {
            document.getElementById('taskAgentId').value = agentId;
            document.getElementById('taskForm').reset();
            new bootstrap.Modal(document.getElementById('taskModal')).show();
        }

        // Assign task
        async function assignTask() {
            try {
                const taskData = {
                    agent_id: document.getElementById('taskAgentId').value,
                    title: document.getElementById('taskTitle').value,
                    description: document.getElementById('taskDescription').value,
                    priority: document.getElementById('taskPriority').value,
                    deadline: document.getElementById('taskDeadline').value || null,
                    notes: document.getElementById('taskNotes').value
                };
                
                const response = await fetch('/api/tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });
                
                if (!response.ok) throw new Error('Failed to assign task');
                
                bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
                showAlert('Task assigned successfully', 'success');
                
            } catch (error) {
                console.error('Error assigning task:', error);
                showAlert('Failed to assign task: ' + error.message, 'danger');
            }
        }

        // View agent performance
        function viewPerformance(agentId) {
            const agent = agents.find(a => a.id === agentId);
            if (!agent) return;
            
            document.getElementById('performanceModalTitle').textContent = `${agent.name} - Performance Details`;
            
            // Create performance chart
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }
            
            const performance = agent.performance || {};
            const labels = Object.keys(performance).filter(key => typeof performance[key] === 'number');
            const data = labels.map(label => performance[label]);
            
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(label => label.replace('_', ' ').toUpperCase()),
                    datasets: [{
                        label: 'Performance Metrics',
                        data: data,
                        backgroundColor: 'rgba(52, 152, 219, 0.6)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ecf0f1'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ecf0f1'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ecf0f1'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            
            // Show performance details
            const detailsContainer = document.getElementById('performanceDetails');
            detailsContainer.innerHTML = `
                <div class="row">
                    ${Object.keys(performance).map(key => `
                        <div class="col-md-6 mb-3">
                            <div class="performance-metric">
                                <div class="performance-value">${performance[key]}</div>
                                <div class="performance-label">${key.replace('_', ' ')}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('performanceModal')).show();
        }

        // Bulk operations
        function bulkOperations() {
            updateSelectedAgentsDisplay();
            new bootstrap.Modal(document.getElementById('bulkModal')).show();
        }

        // Execute bulk operation
        async function executeBulkOperation() {
            const operation = document.getElementById('bulkOperation').value;
            if (!operation || selectedAgents.size === 0) {
                showAlert('Please select an operation and at least one agent', 'warning');
                return;
            }
            
            try {
                let requestData = {
                    agent_ids: Array.from(selectedAgents),
                    operation: operation
                };
                
                if (operation === 'update_status') {
                    requestData.status = document.getElementById('bulkStatus').value;
                }
                
                const response = await fetch('/api/ai-agents/bulk', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) throw new Error('Failed to execute bulk operation');
                
                bootstrap.Modal.getInstance(document.getElementById('bulkModal')).hide();
                selectedAgents.clear();
                await loadAgents();
                showAlert('Bulk operation completed successfully', 'success');
                
            } catch (error) {
                console.error('Error executing bulk operation:', error);
                showAlert('Failed to execute bulk operation: ' + error.message, 'danger');
            }
        }

        // Refresh data
        async function refreshData() {
            await loadAgents();
        }

        // Show loading spinner
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            spinner.style.display = show ? 'block' : 'none';
        }

        // Show alert message
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }
    </script>
</body>
</html>